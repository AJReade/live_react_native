# LiveReact Native Implementation Plan

**Rules for each phase:**
- Always start with TESTS FIRST (TDD approach)
- Mark phases as âœ… COMPLETE when fully tested and documented

---

## ðŸ”„ CRITICAL REFACTORING NEEDED (New Functional API Direction)

**BREAKING CHANGE**: Based on `USAGE_GUIDE.md`, we need to refactor existing implementations from hook-based to functional API approach.

### ðŸ“‹ Refactoring Existing âœ… COMPLETE Phases:

#### âœ… Phase 1.3: LiveViewChannel - Update API Interface âœ… COMPLETE
- [x] **REFACTOR**: `LiveViewChannel` class to match new API specification
- [x] **REFACTOR**: Update `connect()`, `disconnect()`, `joinLiveView()`, `leaveLiveView()` methods
- [x] **REFACTOR**: Update `pushEvent()` and `pushEventTo()` signatures
- [x] **REFACTOR**: Update `handleEvent()` subscription system
- [x] **REFACTOR**: Update all tests to reflect new API
- [x] **VERIFY**: Existing channel tests pass with new API (43/43 tests passing - 100% success rate!)

#### âœ… Phase 2.1B-D: Convert Hooks to Functional API âœ… COMPLETE
- [x] **REFACTOR**: Convert `useLiveView` hook to `createLiveViewClient()` function
- [x] **REFACTOR**: Move state management from React hooks to client instance
- [x] **REFACTOR**: Update `useAdvancedUpdates` to work with functional client (No changes needed - utility hook)
- [x] **REFACTOR**: Update `usePerformanceMonitoring` to work with functional client (No changes needed - utility hook)
- [x] **REFACTOR**: Remove/update old hook tests to functional API tests (Old tests removed, clean 4 tests passing!)
- [x] **VERIFY**: All performance optimizations still work with functional API (93/93 JavaScript tests passing - 100% success rate!)

---

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEVICE (React Native)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              LOCAL TEMPLATES & COMPONENTS               â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  const client = createLiveViewClient({...});           â”‚   â”‚
â”‚  â”‚  client.pushEvent('increment', {});                    â”‚   â”‚
â”‚  â”‚  client.handleEvent('rn:haptic', callback);            â”‚   â”‚
â”‚  â”‚                     â—„â”€â”€ Functional API                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â–²                           â”‚
â”‚                                    â”‚ assigns + events          â”‚
â”‚                                    â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                              WebSocket (JSON)
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                 ELIXIR (LiveView Module)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  import LiveReactNative.RN                                     â”‚
â”‚                                                                 â”‚
â”‚  def handle_event("increment", _params, socket) do              â”‚
â”‚    {:noreply,                                                  â”‚
â”‚     socket                                                     â”‚
â”‚     |> assign(count: socket.assigns.count + 1)               â”‚
â”‚     |> RN.haptic(%{type: "light"})}                          â”‚
â”‚  end                                â—„â”€â”€ RN Namespace API       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## âœ… Phase 1: Foundation Setup (ALREADY COMPLETE)

### âœ… Phase 1.1: Project Structure & Tooling âœ… COMPLETE
- [x] Set up TypeScript, ESLint, Jest configuration
- [x] Create basic project structure for React Native integration
- [x] Install and configure Phoenix dependencies
- [x] Verify toolchain works with basic tests

### âœ… Phase 1.2: Analyze & Adapt LiveReact Core âœ… COMPLETE
- [x] TESTS FIRST: Write comprehensive tests for `LiveReactNative.serialize_assigns/1`
- [x] TESTS FIRST: Write tests for assigns extraction and JSON serialization
- [x] Create `LiveReactNative` module (Elixir) - pure state management
- [x] Implement assigns extraction (filter Phoenix internals)
- [x] Implement JSON serialization for mobile transmission
- [x] Remove all SSR and HTML rendering logic
- [x] **VERIFY**: All Elixir tests pass for core state management

---

## Phase 2: Functional Client API Implementation

### âœ… Phase 2.1: Core `createLiveViewClient()` Function âœ… COMPLETE
- [x] TESTS FIRST: Write tests for `createLiveViewClient()` factory function
- [x] TESTS FIRST: Write tests for client configuration options
- [x] TESTS FIRST: Write tests for client instance state management
- [x] Create `createLiveViewClient(options)` factory function
- [x] Implement client configuration: `url`, `params`, `reconnectDelay`, `debug`, etc.
- [x] Implement client instance with internal state management
- [x] Add proper TypeScript interfaces matching `USAGE_GUIDE.md`
- [x] **VERIFY**: Client creation and configuration works correctly (43/43 tests passing - 100% success rate!)

### âš ï¸ Phase 2.2: Connection Management API âš ï¸ PARTIAL (included in 2.1)
- [x] TESTS FIRST: Write tests for `client.connect()` with promise/callback support
- [x] TESTS FIRST: Write tests for `client.disconnect()` with cleanup
- [x] TESTS FIRST: Write tests for connection state management
- [x] TESTS FIRST: Write tests for reconnection logic and error handling
- [x] Implement `client.connect()` with WebSocket connection
- [x] Implement `client.disconnect()` with full cleanup
- [x] Add connection state tracking and event callbacks
- [x] Add exponential backoff reconnection strategy
- [x] Add proper error handling for connection failures
- [x] **VERIFY**: Connection management is robust and reliable (included in createLiveViewClient tests)

### âš ï¸ Phase 2.3: LiveView Join/Leave API âš ï¸ PARTIAL (included in 2.1)
- [x] TESTS FIRST: Write tests for `client.joinLiveView(path, params, onAssignsUpdate)`
- [x] TESTS FIRST: Write tests for `client.leaveLiveView()` with cleanup
- [x] TESTS FIRST: Write tests for assigns update callbacks
- [x] TESTS FIRST: Write tests for multiple LiveView management
- [x] Implement `client.joinLiveView()` with channel join protocol
- [x] Implement `client.leaveLiveView()` with proper cleanup
- [x] Add assigns update subscription system
- [x] Add support for multiple concurrent LiveViews
- [x] Add LiveView state tracking and error handling
- [x] **VERIFY**: LiveView join/leave cycle works correctly (included in createLiveViewClient tests)

### âš ï¸ Phase 2.4: Event System API âš ï¸ PARTIAL (included in 2.1)
- [x] TESTS FIRST: Write tests for `client.pushEvent(event, payload, onReply?)`
- [x] TESTS FIRST: Write tests for `client.pushEventTo(target, event, payload, onReply?)`
- [x] TESTS FIRST: Write tests for `client.handleEvent(event, callback)` subscription
- [x] TESTS FIRST: Write tests for event cleanup and unsubscription
- [x] TESTS FIRST: Write tests for async/await event patterns
- [x] Implement `client.pushEvent()` with reply handling
- [x] Implement `client.pushEventTo()` for LiveComponent targeting
- [x] Implement `client.handleEvent()` with callback subscription
- [x] Add event cleanup and unsubscription system
- [x] Add support for async/await event patterns
- [x] Add proper error handling for failed events
- [x] **VERIFY**: All event patterns from `USAGE_GUIDE.md` work correctly (included in createLiveViewClient tests)

---

## Phase 3: Server-Side RN Namespace Implementation

### âœ… Phase 3.1: Core RN Module & Navigation âœ… COMPLETE
- [x] **NEW**: Create `LiveReactNative.RN` module for mobile-specific server commands
- [x] **NEW**: Implement navigation functions: `navigate()`, `go_back()`, `reset_stack()`, `replace()`
- [x] TESTS FIRST: Write tests for `RN.navigate(socket, screen, params)`
- [x] TESTS FIRST: Write tests for `RN.go_back(socket)`
- [x] TESTS FIRST: Write tests for `RN.reset_stack(socket, screen)`
- [x] TESTS FIRST: Write tests for `RN.replace(socket, screen, params)`
- [x] Implement `RN.navigate()` for screen navigation
- [x] Implement `RN.go_back()` for navigation stack
- [x] Implement `RN.reset_stack()` and `RN.replace()`
- [x] Add proper event transmission to React Native client
- [x] **VERIFY**: All navigation commands work end-to-end (34/34 tests passing - 100% success rate!)

### Phase 3.2: Native Mobile Features
- [ ] **NEW**: Implement mobile features: `haptic()`, `vibrate()`, `notification()`, `badge()`
- [ ] TESTS FIRST: Write tests for `RN.haptic(socket, options)`
- [ ] TESTS FIRST: Write tests for `RN.vibrate(socket, options)`
- [ ] TESTS FIRST: Write tests for `RN.notification(socket, options)`
- [ ] TESTS FIRST: Write tests for `RN.badge(socket, options)`
- [ ] Implement `RN.haptic()` for haptic feedback
- [ ] Implement `RN.vibrate()` for vibration patterns
- [ ] Implement `RN.notification()` for push notifications
- [ ] Implement `RN.badge()` for app icon badges
- [ ] Add proper option validation and error handling
- [ ] **VERIFY**: All native features trigger correctly on device

### Phase 3.3: UI Interaction Commands
- [ ] **NEW**: Implement UI interactions: `show_toast()`, `show_alert()`, `dismiss_keyboard()`, `show_loading()`
- [ ] TESTS FIRST: Write tests for `RN.show_toast(socket, options)`
- [ ] TESTS FIRST: Write tests for `RN.show_alert(socket, options)`
- [ ] TESTS FIRST: Write tests for `RN.dismiss_keyboard(socket)`
- [ ] TESTS FIRST: Write tests for `RN.show_loading()` and `RN.hide_loading()`
- [ ] Implement `RN.show_toast()` for toast messages
- [ ] Implement `RN.show_alert()` for native alerts with buttons
- [ ] Implement `RN.dismiss_keyboard()` for keyboard management
- [ ] Implement `RN.show_loading()` and `RN.hide_loading()` for loading states
- [ ] Add proper UI interaction event handling
- [ ] **VERIFY**: All UI interactions work correctly

### Phase 3.4: End-to-End Integration
- [ ] **NEW**: Write comprehensive tests for all RN namespace functions
- [ ] **NEW**: **VERIFY**: All RN functions work end-to-end with React Native client

---

## Phase 4: Client-Side Event Handlers

### Phase 4.1: RN Command Handlers (Client-Side)
- [ ] TESTS FIRST: Write tests for automatic `rn:navigate` event handling
- [ ] TESTS FIRST: Write tests for automatic `rn:haptic` event handling
- [ ] TESTS FIRST: Write tests for automatic `rn:notification` event handling
- [ ] TESTS FIRST: Write tests for all RN command handlers
- [ ] Implement automatic `rn:navigate` event handler with React Navigation
- [ ] Implement automatic `rn:haptic` event handler with Haptics API
- [ ] Implement automatic `rn:vibrate` event handler with Vibration API
- [ ] Implement automatic `rn:notification` event handler
- [ ] Add all other RN command handlers (`toast`, `alert`, `loading`, etc.)
- [ ] Add error handling for missing React Native dependencies
- [ ] **VERIFY**: All RN commands trigger appropriate native actions

### Phase 4.2: Performance Optimization Integration
- [ ] TESTS FIRST: Write tests for performance monitoring with functional API
- [ ] TESTS FIRST: Write tests for advanced update strategies with functional API
- [ ] TESTS FIRST: Write tests for assigns diff optimization
- [ ] Integrate existing performance monitoring with functional client
- [ ] Integrate existing advanced update strategies
- [ ] Add assigns diff logging for functional API
- [ ] Add memory leak detection for functional API
- [ ] Add performance profiling hooks for functional API
- [ ] **VERIFY**: Performance optimizations work with new API

---

## Phase 5: Advanced Features

### Phase 5.1: Form Handling Patterns
- [ ] TESTS FIRST: Write tests for real-time form validation patterns
- [ ] TESTS FIRST: Write tests for field-level update handling
- [ ] TESTS FIRST: Write tests for form submission with async/await
- [ ] Create form handling utilities for functional API
- [ ] Add real-time validation with server-side feedback
- [ ] Add field-level update optimizations
- [ ] Add form submission patterns with error handling
- [ ] **VERIFY**: All form patterns from `USAGE_GUIDE.md` work

### Phase 5.2: Real-time Multi-User Features
- [ ] TESTS FIRST: Write tests for multi-user real-time updates
- [ ] TESTS FIRST: Write tests for PubSub integration patterns
- [ ] TESTS FIRST: Write tests for presence tracking
- [ ] Add PubSub integration examples
- [ ] Add presence tracking for multi-user apps
- [ ] Add real-time collaboration patterns
- [ ] Create chat application example
- [ ] **VERIFY**: Multi-user features work correctly

### Phase 5.3: File Upload Integration
- [ ] TESTS FIRST: Write tests for React Native file upload integration
- [ ] TESTS FIRST: Write tests for upload progress tracking
- [ ] TESTS FIRST: Write tests for upload cancellation and retry
- [ ] Integrate with React Native file pickers (ImagePicker, DocumentPicker)
- [ ] Add upload progress tracking and callbacks
- [ ] Add upload cancellation and retry logic
- [ ] Add integration with Phoenix LiveView uploads
- [ ] **VERIFY**: File uploads work end-to-end

---

## Phase 6: Production Readiness

### Phase 6.1: Error Handling & Recovery
- [ ] TESTS FIRST: Write tests for comprehensive error handling
- [ ] TESTS FIRST: Write tests for connection recovery scenarios
- [ ] TESTS FIRST: Write tests for offline/online state management
- [ ] Add comprehensive error boundary system
- [ ] Add automatic connection recovery with backoff
- [ ] Add offline/online state detection and handling
- [ ] Add error reporting and logging
- [ ] **VERIFY**: App handles all error scenarios gracefully

### Phase 6.2: Development Tools & Debugging
- [ ] TESTS FIRST: Write tests for debug mode functionality
- [ ] TESTS FIRST: Write tests for development logging
- [ ] TESTS FIRST: Write tests for performance visualization
- [ ] Add debug mode with comprehensive logging
- [ ] Add development tools for assigns inspection
- [ ] Add performance visualization tools
- [ ] Add React Native debugger integration
- [ ] **VERIFY**: Debug tools provide useful insights

### Phase 6.3: Examples & Documentation
- [ ] Create comprehensive working examples:
  - [ ] Counter app (basic functionality)
  - [ ] Chat app (real-time multi-user)
  - [ ] Form app (validation & submission)
  - [ ] Dashboard app (complex data updates)
- [ ] Update all documentation to reflect functional API
- [ ] Create migration guide from hook-based to functional API
- [ ] Add deployment and production guides
- [ ] **VERIFY**: All examples work and documentation is complete

---

## ðŸš€ Ready for Production!

**FINAL API VERIFICATION**: Library works exactly as specified in `USAGE_GUIDE.md`

### âœ… Client Side Works:
```typescript
const client = createLiveViewClient({
  url: 'ws://localhost:4000/live/websocket',
  params: { _csrf_token: token }
});

await client.connect();
client.joinLiveView('/counter', {}, (assigns) => setAssigns(assigns));
client.pushEvent('increment', {});
client.handleEvent('rn:haptic', ({ type }) => Haptics.impact(type));
```

### âœ… Server Side Works:
```elixir
import LiveReactNative.RN

def handle_event("increment", _params, socket) do
  {:noreply,
   socket
   |> assign(count: socket.assigns.count + 1)
   |> RN.haptic(%{type: "light"})
   |> RN.show_toast(%{message: "Count updated!"})}
end
```

**ARCHITECTURAL INSIGHT**: LiveView = Pure State Service. React Native = Pure UI Layer.
**FUNCTIONAL API**: Clean, predictable, testable, mobile-first! ðŸŽ¯